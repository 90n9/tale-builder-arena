generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  username     String
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stories      Story[]           @relation("AuthorStories")
  comments     Comment[]
  sessions     Session[]
  achievements UserAchievement[]
}

model Story {
  id       Int    @id @default(autoincrement())
  slug     String @unique
  authorId Int
  author   User   @relation("AuthorStories", fields: [authorId], references: [id])

  // versioning & publication
  version     String // e.g. "1.0.0"
  isPublished Boolean @default(false)
  isActive    Boolean @default(true)

  // metadata
  supportedLang String[]
  genre         String
  title         Json // { en: "...", th: "..." }
  subtitle      Json?
  description   Json?
  coverImageUrl String?
  storyJsonUrl  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  comments     Comment[]
  sessions     Session[]
  achievements UserAchievement[]
  versions     StoryVersion[]
}

model StoryVersion {
  id           Int      @id @default(autoincrement())
  storyId      Int
  story        Story    @relation(fields: [storyId], references: [id])
  version      String
  storyJsonUrl String
  createdAt    DateTime @default(now())
  createdBy    Int
}

model Comment {
  id        Int      @id @default(autoincrement())
  storyId   Int
  userId    Int
  story     Story    @relation(fields: [storyId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserAchievement {
  id         Int      @id @default(autoincrement())
  userId     Int
  storyId    Int
  endingKey  String
  achievedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  story Story @relation(fields: [storyId], references: [id])

  @@unique([userId, storyId, endingKey])
}

model Session {
  id            Int           @id @default(autoincrement())
  userId        Int
  storyId       Int
  characterData Json
  currentScene  String?
  history       Json?
  status        SessionStatus @default(IN_PROGRESS)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user  User  @relation(fields: [userId], references: [id])
  story Story @relation(fields: [storyId], references: [id])
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

// Keeping the existing Contact model if it's still needed, or we can remove it if it was just a placeholder.
// Assuming we keep it for now as it was in the file.
model Contact {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(200)
  email       String   @db.VarChar(255)
  requestType String   @map("request_type") @db.VarChar(50)
  subject     String   @db.VarChar(255)
  message     String   @db.Text
  locale      String   @default("th") @db.VarChar(5)
  userAgent   String?  @map("user_agent") @db.Text
  ipAddress   String?  @map("ip_address") @db.VarChar(80)
  referer     String?  @db.Text
  isSpam      Boolean  @default(false) @map("is_spam")
  spamReason  String?  @map("spam_reason") @db.VarChar(255)
  submittedAt DateTime @default(now()) @map("submitted_at") @db.Timestamptz(6)

  @@index([submittedAt], map: "contacts_submitted_at_idx")
  @@map("contacts")
}
